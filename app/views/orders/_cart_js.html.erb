<script type="text/javascript">
$("#addAmount").change(function(){
  var amount = parseInt($(this).val(), 10);
  if ( !(amount > 0) ){
    $(this).val("");
  }
});

$("#addToCart").click(function(){
  var item = new Object();

  if($("#productType").length > 0){
    item = JSON.parse($("#productType").val());
  }
  else{
    item.id = $(this).data("stockid");
    item.name = $(this).data("stockname");
  }

  if(parseInt($("#addAmount").val(), 10)>0){
    addCartItems(item.id, item.name, "<%= (@product.saleprice ? @product.saleprice : @product.price) if(@product) %>", $("#addAmount").val(),"<%= @product.cover if(@product) %>");

    alert("已將"+item.name+"加入購物車。");
  }

  $("#addAmount").val("");
  
});

var cartitems;
cartListItems(getCookie("cart"));

function addCartItems(id, name, price, amount, image){
  var item = new Object();
    item.id = id;
    item.name = name;
    item.price = price;
    item.amount = parseInt(amount, 10);
    item.image = image;

    cartitems[id] = item;

    setCookie('cart', JSON.stringify(cartitems),0,"","/");
    cartListItems(JSON.stringify(cartitems));
}

function getCookie(key)
{
  if( document.cookie.length==0 )   return false;
  var i=document.cookie.search(key+'=');

  if( i==-1 )   return false;
  i+=key.length+1;

  var j=document.cookie.indexOf(';', i);
  if( j==-1 )   j=document.cookie.length;

  return decodeURIComponent(document.cookie.slice(i,j));
}
function setCookie(key, value, expire, domain, path)
{
  var ck = key +'='+ encodeURIComponent(value);
  if(expire)
  {
    var epr=new Date();
    epr.setTime(epr.getTime()+ expire*1000 );
    ck+=';expires='+ epr.toUTCString();
  }
  if( domain ){
    ck+=';domain='+ domain;
  }
  if( path ){
    ck+=';path='+ path;
  }

  document.cookie = ck;
}
function cartListItems(items){
  cartitems = items? JSON.parse(items) : new Object();
  if(Object.keys(cartitems).length>0){
    var html = "", totalPrice = 0;

    $("div.quick>span").text(Object.keys(cartitems).length);

    $("#cartItems").html($("#cartItems tr:first").clone());

    for(var item in cartitems){
      html += '<tr>';
      html += '<td align="center">'+(cartitems[item].image? ('<img src="'+cartitems[item].image+'">') : '無圖片。' )+'</td>';
      html += '<td align="center">'+cartitems[item].name+'</td>';
      html += '<td align="center" class="count"><a href="#" class="minor" data-id="'+cartitems[item].id+'">+</a><input disabled type="text" value="'+parseInt(cartitems[item].amount, 10)+'"><a href="#" class="plus" data-id="'+cartitems[item].id+'">-</a></td>';
      html += '<td align="center">'+(cartitems[item].price)+'</td>';
      html += '<td align="center">'+cartitems[item].price+'</td>';
      html += '<td align="center">'+(parseInt(cartitems[item].amount, 10)*cartitems[item].price)+'</td>';
      html += '<td align="center">有</td>';
      html += '<td align="center" class="delete"><a href="#" data-id="'+cartitems[item].id+'">刪除</a></td>';
      html += '</tr>';
      totalPrice += parseInt(cartitems[item].amount, 10)*cartitems[item].price;
      
    }
    $("span.sum").text(totalPrice);
    $("span.discountpoint").text(Math.floor(totalPrice/200));

    $("#cartItems").append(html);

    $(".delete>a").click(function(event){
      event.preventDefault();
      if(confirm("確定刪除？")){
        delete cartitems[$(this).data("id")];
        setCookie('cart', JSON.stringify(cartitems),0,"","/");
        cartListItems(JSON.stringify(cartitems));
      }
    });

    $("a.plus, a.minor").click(function(event){
      event.preventDefault();
      switch($(this).attr("class")){
        case "plus":
          cartitems[$(this).data("id")].amount += 1;
        break;
        case "minor":
          if(cartitems[$(this).data("id")].amount > 1){
            cartitems[$(this).data("id")].amount -= 1;
          }
          // else{
          //   delete cartitems[$(this).data("id")];
          // }
        break;

      }
      setCookie('cart', JSON.stringify(cartitems),0,"","/");
      cartListItems(JSON.stringify(cartitems));
      
    });

    $(".edit-cartItem").unbind().click(function(){
      if(parseInt($(this).siblings("input").val(), 10)>0){
        addCartItems($(this).data("id"), $(this).data("name"), $(this).data("price"), $(this).siblings("input").val());
      }
      else if(parseInt($(this).siblings("input").val(), 10)==0){
        delete cartitems[$(this).data("id")];
        setCookie('cart', JSON.stringify(cartitems),0,"","/");
        cartListItems(JSON.stringify(cartitems));
      }
      else{
        $(this).siblings("input").val($(this).data("amount"));
      }
    });

    $("#orderCheck").unbind().click(function(){
      window.location.href = "/orders/check";
    });
  }
  else{
    $("div.quick>span").text(0);
    var html = "<p>購物車內沒有任何商品。</p>";
    $("#cartItems").html(html);
    $("span.sum").text(0);
    $("span.discountpoint").text(0);
  }
}
</script>