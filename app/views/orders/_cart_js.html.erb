<script type="text/javascript">

$("#addToCart").click(function(){
  var item = new Object();

  if($("#productType").length > 0){
    item = JSON.parse($("#productType").val());
  }
  else{
    item.id = $(this).data("stockid");
    item.name = $(this).data("stockname");
  }

  if(parseInt($("#addAmount").val(), 10)>0){
    addCartItems(item.id, item.name, "<%= (@product.saleprice ? @product.saleprice : @product.price) if(@product) %>", $("#addAmount").val());
  }

  $("#addAmount").val("");  
});

var cartitems;
cartListItems(getCookie("cart"));

function addCartItems(id, name, price, amount){
  var item = new Object();
    item.id = id;
    item.name = name;
    item.price = price;
    item.amount = amount;

    cartitems[id] = item;

    setCookie('cart', JSON.stringify(cartitems),0,"","/");
    cartListItems(JSON.stringify(cartitems));
}

function getCookie(key)
{
  if( document.cookie.length==0 )   return false;
  var i=document.cookie.search(key+'=');

  if( i==-1 )   return false;
  i+=key.length+1;

  var j=document.cookie.indexOf(';', i);
  if( j==-1 )   j=document.cookie.length;

  return decodeURIComponent(document.cookie.slice(i,j));
}
function setCookie(key, value, expire, domain, path)
{
  var ck = key +'='+ encodeURIComponent(value);
  if(expire)
  {
    var epr=new Date();
    epr.setTime(epr.getTime()+ expire*1000 );
    ck+=';expires='+ epr.toUTCString();
  }
  if( domain ){
    ck+=';domain='+ domain;
  }
  if( path ){
    ck+=';path='+ path;
  }

  document.cookie = ck;
}
function cartListItems(items){
  cartitems = items? JSON.parse(items) : new Object();
  if(Object.keys(cartitems).length>0){
    var html = "", totalPrice = 0;
    html += "總共有"+Object.keys(cartitems).length+"件商品";
    for(var item in cartitems){

      html += "<p>";
      html += "<a href='/products/" + cartitems[item].id + "'>" + cartitems[item].name + "</a> ";
      html += "單價: $"+cartitems[item].price+" <input type='number' value='" + cartitems[item].amount + "'>個 共$" + (cartitems[item].amount*cartitems[item].price) + "。 ";
      html += "<a class='edit-cartItem' data-id='"+cartitems[item].id+"' data-name='"+cartitems[item].name+"' data-price='"+cartitems[item].price+"' data-amount='"+cartitems[item].amount+"'>修改</a>";
      html += "</p>";

      totalPrice += cartitems[item].amount*cartitems[item].price;
      
    }
    html += "<p>總金額：$"+totalPrice+"</p>";
    html += "<p>預期產生的購物金："+Math.floor(totalPrice/200)+"點</p>";
    html += "<p><a id = 'cleanCart'>清空購物車</a> / <a id = 'orderCheck'>結帳</a></p>";

    $("#cartItems").html(html);

    $(".edit-cartItem").unbind().click(function(){
      if(parseInt($(this).siblings("input").val(), 10)>0){
        addCartItems($(this).data("id"), $(this).data("name"), $(this).data("price"), $(this).siblings("input").val());
      }
      else if(parseInt($(this).siblings("input").val(), 10)==0){
        delete cartitems[$(this).data("id")];
        setCookie('cart', JSON.stringify(cartitems),0,"","/");
        cartListItems(JSON.stringify(cartitems));
      }
      else{
        $(this).siblings("input").val($(this).data("amount"));
      }
    });

    $("#orderCheck").unbind().click(function(){
      window.location.href = "/orders/check";
    });

    $("#cleanCart").unbind().click(function(){
      setCookie('cart', "",-2000,"","/");
      cartListItems(getCookie("cart"));
    });
  }
  else{
    var html = "<p>購物車內沒有任何商品。</p>";
    $("#cartItems").html(html);
  }
}
</script>