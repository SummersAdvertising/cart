<% if @orderItems %>

<!--
<% if @traceItems %>
<div class="box">
	<h4>以下商品已售完，請選擇是否加入追蹤清單。</h4>
<% Stock.where(:id => @traceItems).select('products.name, stocks.*').joins("LEFT OUTER JOIN products on products.id = stocks.product_id").each do |tracebook| %>
<p><%= tracebook.name %><%= ("("+tracebook.typename+")" if tracebook.typename != "default") %></p>
<% end %>
</div>
<% end %>
-->

<h3>New order</h3>
<%= form_for(@order) do |f| %>

<% @orderPrice = 0 %>
<% @orderItems.each do |item| %>

<% @itemSum = (item[:saleprice] || item[:price]).to_i * item[:amount].to_i %>
<% @orderPrice = @orderPrice + @itemSum %>

<p><%= item[:name] %> : $<%= item[:saleprice] || item[:price] %>*<%= item[:amount] %>= $<%= @itemSum %></p>
<% end %>

<p>訂單金額：$<%= @orderPrice %></p>
<p>預期產生的購物金：<%= (@orderPrice/200).floor %>點</p>
<p>目前可用購物金：<%= current_member.discountpoint %></p>
<% @discountceiling =  (@orderPrice/10).floor %>
<p>抵用購物金：<input name="discount" type="number" value="<%= (current_member.discountpoint > @discountceiling) ? @discountceiling : current_member.discountpoint %>"></p>

<div class="box">
	<h4>buyer info</h4>

	<p>*name: <%= f.text_field :buyername, :value => current_member.username %></p>
	<p>*tel: <%= f.text_field :buyertel, :value => current_member.tel %></p>
	<p>invoice: <%= f.select(:invoicetype, options_for_select([["二聯式", "二聯式"], ["三聯式", "三聯式"]])) %></p>
	<p>companyNo.: <%= f.text_field :companynum %></p>

	<p><input type="checkbox" name="updateMemberinfo">update as user's info</p>

</div>

<div class="box">
	<h4>receiver info</h4>

	<p>list user's address book</p>
	<p>*name: <%= f.text_field :receivername %></p>
	<p>*address: <%= f.text_field :receiveraddress, :value => current_member.receiveaddress %><br>
		<input type="checkbox" name="addAddressbook">add to address book<br>
		<input type="checkbox" name="setDefault">set as default address
	</p>

	<p>
		<% if current_member.addressbooks.count > 0 %>
		常用地址：
		<% current_member.addressbooks.each do |addressbook| %>
		<a class="addressbook"><%= addressbook.address %></a>
		<% end %>
		<% end %>
	</p>

	<p>*tel: <%= f.text_field :receivertel %></p>
	<p>*payment: <%= f.select(:paytype, options_for_select([["貨到付款", "貨到付款"], ["匯款", "匯款"]])) %></p>
	
</div>

<input type="hidden" name="orderItems" value="<%= @orderItems.to_json %>">
<% end %>

<a href="/orders/cart">修改訂單</a> / <a href="#" id="submit">確認結帳</a>

<script type="text/javascript">
$(".addressbook").click(function(){
	$("#order_receiveraddress").val($(this).html());
});

$("#submit").click(function(){
	$("#new_order").submit();
});
</script>

<% else %>
<script type="text/javascript">
window.location.href = "/orders/cart";
</script>
<% end %>